name: PR Checks

on:
  pull_request:
    branches: [main, dev]
    types: [opened, edited, synchronize, reopened]

jobs:
  pr-title-check:
    name: Validate PR Title
    runs-on: ubuntu-latest
    
    steps:
      - name: Check PR title format
        uses: actions/github-script@v7
        with:
          script: |
            const prTitle = context.payload.pull_request.title;
            
            // Conventional commit patterns
            const patterns = {
              feat: /^feat(\(.+\))?!?:\s.+/,
              fix: /^fix(\(.+\))?!?:\s.+/,
              docs: /^docs(\(.+\))?:\s.+/,
              style: /^style(\(.+\))?:\s.+/,
              refactor: /^refactor(\(.+\))?:\s.+/,
              perf: /^perf(\(.+\))?:\s.+/,
              test: /^test(\(.+\))?:\s.+/,
              chore: /^chore(\(.+\))?:\s.+/,
              ci: /^ci(\(.+\))?:\s.+/,
              build: /^build(\(.+\))?:\s.+/,
              revert: /^revert(\(.+\))?:\s.+/,
              alpha: /^\[alpha\]\s.+/,
              beta: /^\[beta\]\s.+/,
              rc: /^\[rc\]\s.+/
            };
            
            // Check if title matches any pattern
            const matchedType = Object.entries(patterns).find(([type, pattern]) => 
              pattern.test(prTitle)
            );
            
            if (!matchedType) {
              const validExamples = [
                '✅ feat(evals): add new evaluator',
                '✅ fix(agents): correct delegation logic',
                '✅ docs(readme): update installation guide',
                '✅ test(evals): add execution-balance tests',
                '✅ chore(deps): update dependencies',
                '✅ feat!: breaking API change',
                '✅ [alpha] experimental feature'
              ];
              
              const message = `
              ## ❌ Invalid PR Title Format
              
              **Current title:** \`${prTitle}\`
              
              ### Required Format
              PR titles must follow [Conventional Commits](https://www.conventionalcommits.org/) format:
              
              \`\`\`
              <type>(<scope>): <description>
              \`\`\`
              
              ### Valid Types
              - **feat** - New feature (triggers minor version bump: 0.3.0 → 0.4.0)
              - **fix** - Bug fix (triggers patch version bump: 0.3.0 → 0.3.1)
              - **docs** - Documentation changes (triggers patch bump)
              - **test** - Test additions/changes (triggers patch bump)
              - **refactor** - Code refactoring (triggers patch bump)
              - **chore** - Maintenance tasks (triggers patch bump)
              - **ci** - CI/CD changes (triggers patch bump)
              - **perf** - Performance improvements (triggers patch bump)
              - **style** - Code style changes (triggers patch bump)
              - **build** - Build system changes (triggers patch bump)
              - **revert** - Revert previous commit (triggers patch bump)
              
              ### Breaking Changes
              - **feat!:** or **fix!:** - Breaking change (triggers major version bump: 0.3.0 → 1.0.0)
              - **BREAKING CHANGE:** in description
              
              ### Pre-release Tags
              - **[alpha]** - Alpha release (0.3.0 → 0.3.1-alpha.1)
              - **[beta]** - Beta release (0.3.0 → 0.3.1-beta.1)
              - **[rc]** - Release candidate (0.3.0 → 0.3.1-rc.1)
              
              ### Valid Examples
              ${validExamples.map(ex => `- ${ex}`).join('\n')}
              
              ### Why This Matters
              - ✅ Enables automatic semantic versioning
              - ✅ Generates meaningful changelogs
              - ✅ Makes commit history searchable
              - ✅ Clarifies the impact of changes
              
              ### How to Fix
              Edit your PR title to match the format above.
              `;
              
              core.setFailed(message);
              
              // Also post as a comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                body: message
              });
            } else {
              const [type] = matchedType;
              let versionBump = 'patch (0.3.0 → 0.3.1)';
              
              if (type === 'feat' && prTitle.includes('!')) {
                versionBump = 'major (0.3.0 → 1.0.0) - BREAKING CHANGE';
              } else if (type === 'feat') {
                versionBump = 'minor (0.3.0 → 0.4.0)';
              } else if (type === 'fix' && prTitle.includes('!')) {
                versionBump = 'major (0.3.0 → 1.0.0) - BREAKING CHANGE';
              } else if (type === 'alpha') {
                versionBump = 'alpha (0.3.0 → 0.3.1-alpha.1)';
              } else if (type === 'beta') {
                versionBump = 'beta (0.3.0 → 0.3.1-beta.1)';
              } else if (type === 'rc') {
                versionBump = 'rc (0.3.0 → 0.3.1-rc.1)';
              }
              
              const message = `
              ## ✅ PR Title Valid
              
              **Title:** \`${prTitle}\`
              **Type:** \`${type}\`
              **Version bump:** ${versionBump}
              
              When this PR is merged using **"Squash and Merge"**, the version will be automatically bumped.
              `;
              
              core.info(message);
              
              // Set output for summary
              core.summary
                .addHeading('✅ PR Title Validation Passed', 2)
                .addRaw(`**Title:** \`${prTitle}\``)
                .addBreak()
                .addRaw(`**Type:** \`${type}\``)
                .addBreak()
                .addRaw(`**Version bump:** ${versionBump}`)
                .write();
            }

  build-check:
    name: Build & Validate
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'evals/framework/package-lock.json'
      
      - name: Install dependencies
        working-directory: evals/framework
        run: npm ci
      
      - name: Build framework
        working-directory: evals/framework
        run: npm run build
      
      - name: Validate test suites
        working-directory: evals/framework
        run: npm run validate:suites:all
      
      - name: Summary
        if: success()
        run: |
          echo "## ✅ Build Check Passed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ TypeScript compilation successful" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Test suite validation passed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Note:** Full agent tests are not run on PRs to save time and costs." >> $GITHUB_STEP_SUMMARY
          echo "Maintainers can run \`npm run test:ci\` locally if needed." >> $GITHUB_STEP_SUMMARY
      
      - name: Failure summary
        if: failure()
        run: |
          echo "## ❌ Build Check Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Please check the logs above for details." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Common fixes:**" >> $GITHUB_STEP_SUMMARY
          echo "- TypeScript errors: Fix type issues in \`evals/framework/src/\`" >> $GITHUB_STEP_SUMMARY
          echo "- YAML validation: Check test files in \`evals/agents/*/tests/\`" >> $GITHUB_STEP_SUMMARY
